# .github/workflows/deploy.yml
name: Deploy to EC2 via CodeDeploy

on:
  push:
    branches:
      - main

env:
  AWS_REGION: ca-central-1
  APPLICATION_NAME: laravel-api
  DEPLOYMENT_GROUP: laravel-api-deployment-group
  S3_BUCKET: dashboard-dev-app

jobs:
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Create deployment package
      run: |
        # Create deployment artifact
        mkdir -p deployment-package
        
        # Copy application files
        rsync -av --progress . deployment-package/ \
          --exclude .git \
          --exclude .github \
          --exclude node_modules \
          --exclude tests \
          --exclude .env.example \
          --exclude deployment-package
        
        # Create archive
        cd deployment-package
        zip -r ../deployment-${{ github.sha }}.zip .
        cd ..

    - name: Upload to S3
      run: |
        aws s3 cp deployment-${{ github.sha }}.zip \
          s3://${{ env.S3_BUCKET }}/deployments/deployment-${{ github.sha }}.zip

    - name: Create CodeDeploy deployment
      id: deploy
      run: |
        deployment_id=$(aws deploy create-deployment \
          --application-name ${{ env.APPLICATION_NAME }} \
          --deployment-group-name ${{ env.DEPLOYMENT_GROUP }} \
          --s3-location bucket=${{ env.S3_BUCKET }},key=deployments/deployment-${{ github.sha }}.zip,bundleType=zip \
          --description "Deployment from GitHub commit ${{ github.sha }}" \
          --query 'deploymentId' \
          --output text)
        
        echo "deployment_id=$deployment_id" >> $GITHUB_OUTPUT
        echo "Deployment ID: $deployment_id"

    - name: Wait for deployment to complete
      run: |
        echo "Waiting for deployment ${{ steps.deploy.outputs.deployment_id }} to complete..."
        
        aws deploy wait deployment-successful \
          --deployment-id ${{ steps.deploy.outputs.deployment_id }}
        
        echo "Deployment completed successfully!"

    - name: Get deployment status
      if: always()
      run: |
        aws deploy get-deployment \
          --deployment-id ${{ steps.deploy.outputs.deployment_id }} \
          --query 'deploymentInfo.status' \
          --output text